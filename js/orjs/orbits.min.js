(function() {
    var Orbits, Renderer, Physics, UI, Sat;
    var sats = [], earth, debug;

    (function() {
        Orbits = function(opts) {
            earth = opts.settings.earth;
            Orbits.setEarthMass(earth.m);
            Orbits.UI = UI(opts.ui);
            Orbits.Renderer = Renderer(opts.renderer);
            Orbits.Physics = Physics(opts.physics);
            debug = document.getElementById("DEBUG");
            return Orbits;
        };

        Orbits.setEarthMass = function(mass) {
            earth.m = mass * 1E11; // 乘以1E11设置地球质量
        };
    })();

    (function() {
        var ctx, earthImg, earthImgLoaded = false;

        Renderer = function(opts) {
            ctx = UI.canvas.getContext("2d");
            earthImg = new Image();
            earthImg.src = opts.earthimg;
            earthImg.onload = function() {
                earthImgLoaded = true;
            };
            return Renderer;
        };

        Renderer.redraw = function() {
            ctx.clearRect(0, 0, UI.canvas.width, UI.canvas.height);
            for (var i = 0; i < sats.length; i++) {
                sats[i].draw();
            }
            if (!earthImgLoaded) {
                drawCircle({
                    x: earth.x,
                    y: earth.y,
                    radius: earth.r,
                    strokeStyle: "#00FF00",
                    fillStyle: "#00FF00"
                });
            } else {
                ctx.drawImage(earthImg, earth.x - earthImg.width / 2, earth.y - earthImg.height / 2);
            }
        };

        Renderer.drawSatellite = function(opts) {
            var xpoints = opts.xpoints;
            var ypoints = opts.ypoints;
            var color = opts.color; // 每条轨迹的颜色
        
            if (xpoints.length > 1) {
                ctx.beginPath();
                ctx.moveTo(xpoints[0], ypoints[0]); // 移动到第一个点
        
                // 遍历所有点并连接成线段
                for (var i = 1; i < xpoints.length; i++) {
                    ctx.lineTo(xpoints[i], ypoints[i]);
                }
        
                ctx.strokeStyle = color || "#FFFFFF"; // 设置整条轨迹的颜色
                ctx.lineWidth = 1.5; // 设置线条宽度
                ctx.stroke(); // 绘制线条
            }
        
            // 绘制当前卫星位置
            drawCircle(opts); // 继续绘制卫星本身
        };
        
        function drawCircle(opts) {
            if (opts.x !== undefined && opts.y !== undefined && opts.radius !== undefined) {
                ctx.beginPath();
                ctx.arc(opts.x, opts.y, opts.radius, 0, Math.PI * 2, true);
                if (opts.strokeStyle !== undefined) {
                    ctx.strokeStyle = opts.strokeStyle;
                    ctx.stroke();
                }
                if (opts.fillStyle !== undefined) {
                    ctx.fillStyle = opts.fillStyle;
                    ctx.fill();
                }
            }
        }
    })();

    (function() {
        var timestep = 1;

        Physics = function() {
            return Physics;
        };

        Physics.setTimestep = function(ts) {
            timestep = ts;
        };

        Physics.getTimestep = function() {
            return timestep;
        };

        Physics.reCalc = function(store) {
            var collisions = [];
            for (var i = sats.length - 1; i >= 0; i--) {
                var sat = sats[i];
                var d = (sat.x - earth.x) * (sat.x - earth.x) + (sat.y - earth.y) * (sat.y - earth.y);

                if (d <= earth.r2) {
                    collisions.push(i);
                } else {
                    var theta = Math.atan2(sat.y - earth.y, sat.x - earth.x);
                    var k = -6.673E-11 * earth.m * sat.m / d;
                    sat.u += k * Math.cos(theta) / sat.m * timestep;
                    sat.v += k * Math.sin(theta) / sat.m * timestep;

                    if (store === true) {
                        sat.xpoints.push(sat.x);
                        sat.ypoints.push(sat.y);
                        sat.colors.push(
                            Math.abs(sat.initSpeed - Math.sqrt(sat.u * sat.u + sat.v * sat.v)) < 0.1 ? "rgb(256, 256, 0)" :
                            Math.sqrt(sat.u * sat.u + sat.v * sat.v) > sat.initSpeed * 1.5 ? "rgb(256, 0, 0)" :
                            Math.sqrt(sat.u * sat.u + sat.v * sat.v) > sat.initSpeed ? "rgb(256, 128, 128)" :
                            Math.sqrt(sat.u * sat.u + sat.v * sat.v) > sat.initSpeed / 1.2 ? "rgb(64, 64, 256)" :
                            "rgb(128, 256, 256)"
                        );
                    }

                    sat.x += sat.u * timestep;
                    sat.y += sat.v * timestep;
                }
            }

            for (var i = collisions.length - 1; i >= 0; i--) {
                sats.splice(collisions[i], 1);
            }
        };
    })();

    (function() {
        var canvas, satMass, earthMass, initX, initY, earthMassLbl, satMassLbl, initXLbl, initYLbl, timeStepLbl, timestep;

        UI = function(opts) {
            UI.canvas = canvas = document.getElementById(opts.canvas);
            satMass = document.getElementById(opts.satmass);
            earthMass = document.getElementById(opts.earthmass);
            initX = document.getElementById(opts.initx);
            initY = document.getElementById(opts.inity);
            timestep = document.getElementById(opts.timestep);
            earthMassLbl = document.getElementById(opts.earthmasslbl);
            timeStepLbl = document.getElementById(opts.timesteplbl);
            satMassLbl = document.getElementById(opts.satmasslbl);
            initXLbl = document.getElementById(opts.initxlbl);
            initYLbl = document.getElementById(opts.initylbl);

            earthMassLbl.innerHTML = opts.defaultearthmass;
            timeStepLbl.innerHTML = opts.defaulttimestep;
            satMassLbl.innerHTML = opts.defaultsatmass;
            initXLbl.innerHTML = opts.defaultinitx;
            initYLbl.innerHTML = opts.defaultinity;
            Physics.setTimestep(opts.defaulttimestep);

            $(earthMass).slider({
                slide: function(event, ui) {
                    var mass = parseFloat(ui.value);
                    earthMassLbl.innerHTML = mass;
                    Orbits.setEarthMass(mass);
                },
                value: opts.defaultearthmass,
                min: 1,
                max: 100,
                step: 1
            });

            $(timestep).slider({
                slide: function(event, ui) {
                    var ts = parseFloat(ui.value);
                    timeStepLbl.innerHTML = ts;
                    Physics.setTimestep(ts);
                },
                value: opts.defaulttimestep,
                min: 0.01,
                max: 0.1,
                step: 0.01
            });

            $(satMass).slider({
                slide: function(event, ui) {
                    var mass = parseFloat(ui.value);
                    satMassLbl.innerHTML = mass;
                },
                value: opts.defaultsatmass,
                min: 1,
                max: 30,
                step: 1
            });

            $(initX).slider({
                slide: function(event, ui) {
                    initXLbl.innerHTML = ui.value;
                },
                value: opts.defaultinitx,
                min: -3,
                max: 3,
                step: 0.5
            });

            $(initY).slider({
                slide: function(event, ui) {
                    initYLbl.innerHTML = ui.value;
                },
                value: opts.defaultinity,
                min: -3,
                max: 3,
                step: 0.5
            });

            $(UI.canvas).click(canvasClicked);
            $("#RESET_INPUT").click(function() {
                sats = [];
            });

            return UI;
        };

        function canvasClicked(e) {
            var top = 0, left = 0, obj = canvas;
            while (obj.tagName !== "BODY") {
                top += obj.offsetTop;
                left += obj.offsetLeft;
                obj = obj.offsetParent;
            }

            Orbits.setEarthMass(parseFloat(earthMassLbl.innerHTML));

            sats.push(new Sat({
                x: parseInt(e.clientX - left + window.pageXOffset),
                y: parseInt(e.clientY - top + window.pageYOffset),
                u: parseFloat($(initX).slider("value")),
                v: parseFloat($(initY).slider("value")),
                m: parseFloat($(satMass).slider("value")),
                color: getRandomColor() // 添加随机颜色
            }));
        }
    })();

    (function() {
        // 定义卫星类
        Sat = function(opts) {
            this.u = opts.u;
            this.v = opts.v;
            this.x = opts.x;
            this.y = opts.y;
            this.m = opts.m;
            this.initSpeed = Math.sqrt(opts.u * opts.u + opts.v * opts.v);
            this.xpoints = [];
            this.ypoints = [];
            this.colors = [];
            this.color = opts.color; // 添加颜色属性
        };

        Sat.prototype.draw = function() {
            Renderer.drawSatellite({
                x: this.x,
                y: this.y,
                radius: 3.75,
                strokeStyle: "#FFFFFF",
                fillStyle: "#FFFFFF",
                xpoints: this.xpoints,
                ypoints: this.ypoints,
                color: this.color // 使用卫星的轨迹颜色
            });
        };
    })();

    (function() {
        window.Orbits = Orbits({
            renderer: {
                earthimg: "../img/orimg/earth.png"
            },
            physics: {},
            ui: {
                canvas: "CANVAS_BOARD",
                satmass: "SAT_MASS_INPUT",
                satmasslbl: "SAT_MASS_LBL",
                earthmass: "EARTH_MASS_INPUT",
                earthmasslbl: "EARTH_MASS_LBL",
                initx: "INIT_X_INPUT",
                initxlbl: "INIT_X_LBL",
                inity: "INIT_Y_INPUT",
                initylbl: "INIT_Y_LBL",
                timesteplbl: "TIME_STEP_LBL",
                timestep: "TIME_STEP_INPUT",
                defaultsatmass: 15,
                defaultearthmass: 60,
                defaultinitx: 0,
                defaultinity: 1.5,
                defaulttimestep: 0.05
            },
            settings: {
                earth: {
                    x: 310,
                    y: 290,
                    r: 10,
                    r2: 100,
                    m: 50
                }
            }
        });
        setInterval(function() {
            Renderer.redraw();
            for (var i = 30; i > -1; i--) {
                Physics.reCalc();
            }
            Physics.reCalc(true);
        }, 25);

    })();

    // 生成随机颜色的函数
    function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
})();
